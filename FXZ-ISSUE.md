# FXZ VPN ルーティング問題

## 概要

FXZ VPN は `utun` インターフェース（例: `utun6`）経由で接続し、ルーティングテーブルを積極的に変更してローカルネットワーク宛のトラフィックをVPNトンネル経由にリダイレクトする。`check-fxz.py` はこの問題を検出し、ローカルルーティングを復元するコマンドを生成する。

## FXZ のルーティング挙動

### IPv4

FXZ は `utun6` 経由で以下の種類のルートを追加する:

| 種類 | 例 | 説明 |
|------|------|------|
| サブネット分割 | `192.168.1.0/25`, `192.168.1.128/25` | ローカルの /24 を2つの /25 に分割 |
| ホストルート | `192.168.1.1`, `192.168.1.12`, ... | ARPテーブルに基づく個別ホストルート |
| 広域キャッチオール | `192.0.0.0/3` | より具体的なルートにマッチしない 192.x.x.x トラフィックを捕捉 |

`/25` 分割とホストルートは、ローカルの `192.168.1.0/24`（en0）ルートよりも具体的（最長プレフィックスマッチ）なため、そちらが優先される。

FXZ が個別ルートを追加しないネットワーク（例: `192.168.2.0/24`, `192.168.3.0/24`）は、広域の `192.0.0.0/3` ルートに捕捉される。

### IPv6

FXZ はローカルの `/64` プレフィックスを2つの `/65` サブネットに分割する:

| 種類 | 例 |
|------|------|
| サブネット分割 | `240d:1a:6da:3311::/65`, `240d:1a:6da:3311:8000::/65` |
| キャッチオール | `::/1`, `8000::/1` |

`/65` ルートがローカルの `/64` ルートを上書きする。キャッチオールルート（`::/1`, `8000::/1`）はインターネット全般のトラフィックを扱う。

**FXZ の IPv6 が無効な場合**: `networksetup -setv6off "FXZ"` でサービスの IPv6 を無効化しても、VPN 接続時に `::/1` と `8000::/1` がルーティングテーブルに追加される問題がある。この場合、IPv6 通信が VPN トンネル経由になり正しく動作しないため、修正スクリプトでこれらも削除対象とする。

## 修正方針 (`check-fxz.py -f`)

### 1. ローカルネットワーク向けの FXZ ルートを削除

定義されたローカルネットワーク範囲に含まれる `utun` ルートをすべて削除する:

```
ip route del 192.168.1.0/25 dev utun6
ip route del 192.168.1.1 dev utun6
...
ip route del 192.168.1.128/25 dev utun6
ip route del 192.168.2.1 dev utun6
ip -6 route del 240d:1a:6da:3311::/65 dev utun6
ip -6 route del 240d:1a:6da:3311:8000::/65 dev utun6
```

FXZ の IPv6 が無効（`networksetup -setv6off "FXZ"`）にもかかわらず IPv6 ハーフデフォルトルートが追加されている場合は、追加で削除する:

```
ip -6 route del ::/1 dev utun6
ip -6 route del 8000::/1 dev utun6
```

### 2. 明示的なローカルルートを追加

削除後もトラフィックが広域の `192.0.0.0/3` ルートに捕捉される可能性がある。これを防ぐため、ゲートウェイ経由で到達可能なすべてのネットワークに対して明示的なルートを追加する:

```
ip route add 192.168.1.0/24 via 192.168.1.1 dev en0
ip route add 192.168.2.0/24 via 192.168.1.1 dev en0
ip route add 192.168.3.0/24 via 192.168.1.1 dev en0
```

既存のルートと重複する場合（例: `192.168.1.0/24` は既に en0 上に存在）は失敗するが、問題はない。

## ネットワーク定義

### ゲートウェイ経由ネットワーク（route del + route add）

デフォルトゲートウェイ（`192.168.1.1`）経由で到達可能なネットワーク:

- `192.168.1.0/24` - プライマリ LAN
- `192.168.2.0/24` - セカンダリ LAN
- `192.168.3.0/24` - ターシャリ LAN

### 直接接続ネットワーク（route del のみ）

Mac に直接接続されているネットワーク（ゲートウェイ不要）:

- `10.211.55.0/24` - Parallels Desktop

### IPv6 ローカルネットワーク（自動検出）

`en0` のグローバルユニキャストアドレスから自動検出される。リンクローカル（`fe80::/10`）は除外。

## Proxifier との相互作用

ルーティングテーブルを修正しても、Proxifier が HTTP トラフィックを横取りして OS レベルのルーティングを無視し、VPN トンネル経由でルーティングする場合がある。修正適用後も `192.168.2.x` 等のローカルネットワークに到達できない場合は、Proxifier のルールを確認し、ローカルネットワーク範囲を例外に追加すること。

## 使い方

```bash
# 影響を受けるローカルルートの数を確認
./check-fxz.py

# デバッグ情報を表示（検出されたネットワーク、マッチしたルート）
./check-fxz.py -d

# 修正コマンドを生成
./check-fxz.py -f

# 修正を適用（シェルにパイプ）
./check-fxz.py -f | sudo sh
```
